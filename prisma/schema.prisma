// Expense Tracker - Multi-Schema Prisma Configuration
// Following your e-commerce pattern with schema-per-module

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["multiSchema"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["identity_workspace", "expense_ledger"]
}

// ============================================
// SCHEMA: identity_workspace
// ============================================

model UserAccount {
  id            String   @id @default(uuid())
  email         String   @unique
  passwordHash  String   @map("password_hash")
  fullName      String?  @map("full_name")
  isActive      Boolean  @default(true) @map("is_active")
  emailVerified Boolean  @default(false) @map("email_verified")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  workspaceMemberships WorkspaceMembership[]

  @@map("user_account")
  @@schema("identity_workspace")
}

model Workspace {
  id        String   @id @default(uuid())
  name      String
  slug      String   @unique
  ownerId   String   @map("owner_id")
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  members WorkspaceMembership[]

  @@map("workspace")
  @@schema("identity_workspace")
}

model WorkspaceMembership {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  workspaceId String   @map("workspace_id")
  role        String   // owner, admin, member
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  user      UserAccount @relation(fields: [userId], references: [id], onDelete: Cascade)
  workspace Workspace   @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([userId, workspaceId])
  @@index([workspaceId])
  @@index([userId])
  @@map("workspace_membership")
  @@schema("identity_workspace")
}

model WorkspaceInvitation {
  id          String   @id @default(uuid())
  workspaceId String   @map("workspace_id")
  email       String
  role        String
  token       String   @unique
  expiresAt   DateTime @map("expires_at")
  acceptedAt  DateTime? @map("accepted_at")
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([workspaceId])
  @@index([email])
  @@map("workspace_invitation")
  @@schema("identity_workspace")
}

model AuthSession {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@map("auth_session")
  @@schema("identity_workspace")
}

// ============================================
// SCHEMA: expense_ledger
// ============================================

enum PaymentMethod {
  CASH
  CREDIT_CARD
  DEBIT_CARD
  BANK_TRANSFER
  CHECK
  DIGITAL_WALLET
  OTHER

  @@schema("expense_ledger")
}

enum ExpenseStatus {
  DRAFT
  SUBMITTED
  APPROVED
  REJECTED
  REIMBURSED

  @@schema("expense_ledger")
}

model Expense {
  id                String             @id @default(uuid()) @db.Uuid
  workspaceId       String             @map("workspace_id") @db.Uuid
  userId            String             @map("user_id") @db.Uuid
  title             String             @db.VarChar(255)
  description       String?            @db.Text
  amount            Decimal            @db.Decimal(12, 2)
  currency          String             @default("USD") @db.VarChar(3)
  expenseDate       DateTime           @map("expense_date") @db.Date
  categoryId        String?            @map("category_id") @db.Uuid
  merchant          String?            @db.VarChar(255)
  paymentMethod     PaymentMethod      @default(CASH) @map("payment_method")
  isReimbursable    Boolean            @default(false) @map("is_reimbursable")
  status            ExpenseStatus      @default(SUBMITTED)
  createdAt         DateTime           @default(now()) @map("created_at") @db.Timestamptz
  updatedAt         DateTime           @updatedAt @map("updated_at") @db.Timestamptz

  category          Category?          @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  tags              ExpenseTag[]
  attachments       Attachment[]

  @@index([workspaceId])
  @@index([userId])
  @@index([categoryId])
  @@index([expenseDate])
  @@index([status])
  @@index([createdAt])
  @@map("expenses")
  @@schema("expense_ledger")
}

model Category {
  id          String   @id @default(uuid()) @db.Uuid
  workspaceId String   @map("workspace_id") @db.Uuid
  name        String   @db.VarChar(100)
  description String?  @db.VarChar(500)
  color       String?  @db.VarChar(7)
  icon        String?  @db.VarChar(50)
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz

  expenses Expense[]

  @@unique([workspaceId, name], map: "category_workspace_name")
  @@index([workspaceId])
  @@map("categories")
  @@schema("expense_ledger")
}

model Tag {
  id          String   @id @default(uuid()) @db.Uuid
  workspaceId String   @map("workspace_id") @db.Uuid
  name        String   @db.VarChar(50)
  color       String?  @db.VarChar(7)
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz

  expenses ExpenseTag[]

  @@unique([workspaceId, name], map: "tag_workspace_name")
  @@index([workspaceId])
  @@map("tags")
  @@schema("expense_ledger")
}

model ExpenseTag {
  expenseId String   @map("expense_id") @db.Uuid
  tagId     String   @map("tag_id") @db.Uuid
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz

  expense Expense @relation(fields: [expenseId], references: [id], onDelete: Cascade)
  tag     Tag     @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([expenseId, tagId])
  @@index([expenseId])
  @@index([tagId])
  @@map("expense_tags")
  @@schema("expense_ledger")
}

model Attachment {
  id         String   @id @default(uuid()) @db.Uuid
  expenseId  String   @map("expense_id") @db.Uuid
  fileName   String   @map("file_name") @db.VarChar(255)
  filePath   String   @map("file_path") @db.VarChar(500)
  fileSize   Int      @map("file_size")
  mimeType   String   @map("mime_type") @db.VarChar(100)
  uploadedBy String   @map("uploaded_by") @db.Uuid
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz

  expense Expense @relation(fields: [expenseId], references: [id], onDelete: Cascade)

  @@index([expenseId])
  @@map("attachments")
  @@schema("expense_ledger")
}

enum RecurrenceFrequency {
  DAILY
  WEEKLY
  MONTHLY
  YEARLY

  @@schema("expense_ledger")
}

enum RecurrenceStatus {
  ACTIVE
  PAUSED
  COMPLETED

  @@schema("expense_ledger")
}

model RecurringExpense {
  id              String              @id @default(uuid()) @db.Uuid
  workspaceId     String              @map("workspace_id") @db.Uuid
  userId          String              @map("user_id") @db.Uuid
  frequency       RecurrenceFrequency
  interval        Int                 @default(1)
  startDate       DateTime            @map("start_date") @db.Date
  endDate         DateTime?           @map("end_date") @db.Date
  nextRunDate     DateTime            @map("next_run_date") @db.Date
  status          RecurrenceStatus    @default(ACTIVE)
  template        Json                // Stores { title, amount, currency, categoryId, etc. }
  createdAt       DateTime            @default(now()) @map("created_at") @db.Timestamptz
  updatedAt       DateTime            @updatedAt @map("updated_at") @db.Timestamptz

  @@index([workspaceId])
  @@index([userId])
  @@index([nextRunDate])
  @@index([status])
  @@map("recurring_expenses")
  @@schema("expense_ledger")
}
